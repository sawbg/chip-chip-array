\hypertarget{Grabber_8hpp_source}{\section{Grabber.\+hpp}
\label{Grabber_8hpp_source}\index{src/\+Grabber.\+hpp@{src/\+Grabber.\+hpp}}
}

\begin{DoxyCode}
00001 
00007 \textcolor{preprocessor}{#ifndef Grabber\_H}
00008 \textcolor{preprocessor}{#define Grabber\_H}
00009 
00010 \textcolor{preprocessor}{#include <cmath>}
00011 \textcolor{preprocessor}{#include <map>}
00012 \textcolor{preprocessor}{#include <opencv2/highgui/highgui.hpp>}
00013 \textcolor{preprocessor}{#include <opencv2/imgproc/imgproc.hpp>}
00014 \textcolor{preprocessor}{#include <string>}
00015 \textcolor{preprocessor}{#include <unistd.h>}
00016 \textcolor{preprocessor}{#include <vector>}
00017 
00018 \textcolor{preprocessor}{#include "\hyperlink{Arm_8hpp}{Arm.hpp}"}
00019 \textcolor{preprocessor}{#include "\hyperlink{definitions_8hpp}{definitions.hpp}"}
00020 \textcolor{preprocessor}{#include "\hyperlink{Block_8hpp}{Block.hpp}"}
00021 \textcolor{preprocessor}{#include "\hyperlink{Log_8hpp}{Log.hpp}"}
00022 \textcolor{preprocessor}{#include "\hyperlink{PiCamera_8hpp}{PiCamera.hpp}"}
00023 
00024 \textcolor{keyword}{namespace }\hyperlink{namespaceChipChipArray}{ChipChipArray} \{
00025 
\hypertarget{Grabber_8hpp_source_l00030}{}\hyperlink{classChipChipArray_1_1Grabber}{00030}     \textcolor{keyword}{class }\hyperlink{classChipChipArray_1_1Grabber}{Grabber} \{
00031         \textcolor{keyword}{public}:
00043             \hyperlink{classChipChipArray_1_1Grabber_a7333f40c135fbe92d59651f75032b4e7}{Grabber}(\hyperlink{definitions_8hpp_adbd1e7a33d3e1751c7b2aa2562d0ecb9}{Zone} \hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone}, \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142}{Side} \hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side});
00044 
00049             \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_aacf089ceb4aa5b263c2cc702fb3daf74}{Close}();
00050 
00051 
00058             \hyperlink{definitions_8hpp_ab84ebabb02540c4a7ec341a213abf1dc}{Result} \hyperlink{classChipChipArray_1_1Grabber_a56639f8f9ba9468bce4b6d69ceb2eb54}{Load}();
00059 
00060         \textcolor{keyword}{protected}:
\hypertarget{Grabber_8hpp_source_l00064}{}\hyperlink{classChipChipArray_1_1Grabber_a726bcc2367a719cb84de92a981947622}{00064}             \hyperlink{classChipChipArray_1_1PiCamera}{PiCamera} \hyperlink{classChipChipArray_1_1Grabber_a726bcc2367a719cb84de92a981947622}{cam};
00065 
\hypertarget{Grabber_8hpp_source_l00071}{}\hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{00071}             \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142}{Side} \hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side};
00072 
\hypertarget{Grabber_8hpp_source_l00076}{}\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{00076}             \hyperlink{definitions_8hpp_adbd1e7a33d3e1751c7b2aa2562d0ecb9}{Zone} \hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone};
00077 
00081             \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_a44e5aeb908634f68de356ad8df3c4bf1}{Deposit}(\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436}{Color} color = \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue});
00082 
00087             \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_abecb4047b4f7d5a7e691b7fb581b5a39}{Extend}();
00088 
00099             \hyperlink{classChipChipArray_1_1Block}{Block} \hyperlink{classChipChipArray_1_1Grabber_af49248c957a1695dcde79c0f5f8df99b}{LocateBlocks}(\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436}{Color} color = 
      \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a1e700ac224a6d34c5b171bb6f462aa41}{Color::Perrywinkle});
00100 
00106             \hyperlink{classChipChipArray_1_1Block}{Block} \hyperlink{classChipChipArray_1_1Grabber_ab9b0d6a64b2c94c0d0f810a5ebeef6ec}{LocateBlueBlock}();
00107 
00108         \textcolor{keyword}{private}:
00112             \textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{definitions_8hpp_a1134b580f8da4de94ca6b1de4d37975e}{uint32} MIN\_HALF\_BLOCK\_SIZE = 50000;
00113 
00118             \textcolor{keyword}{static} \hyperlink{classChipChipArray_1_1Log}{Log} log;
00119 
00124             \hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} invokeCount = 0;
00125 
00130             std::map<Color, std::array<cv::Scalar, 2>> rangeVals;
00131 
00135             \hyperlink{classChipChipArray_1_1Arm}{Arm} arm;
00136     \};
00137 
00141     \hyperlink{classChipChipArray_1_1Log}{Log} Grabber::log(\textcolor{stringliteral}{"logs/Grabber"}, \hyperlink{definitions_8hpp_aa7380b6d694cab49f07aed6a7af592d9ace7898536dd0e928d1640ee2ad531cc8}{LogMode::Multi});
00142 
\hypertarget{Grabber_8hpp_source_l00143}{}\hyperlink{classChipChipArray_1_1Grabber_a7333f40c135fbe92d59651f75032b4e7}{00143}     \hyperlink{classChipChipArray_1_1Grabber_a7333f40c135fbe92d59651f75032b4e7}{Grabber::Grabber}(\hyperlink{definitions_8hpp_adbd1e7a33d3e1751c7b2aa2562d0ecb9}{Zone} zone, \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142}{Side} side) \{
00144         log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\textcolor{stringliteral}{"Opening Grabber"});
00145         log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(\textcolor{stringliteral}{"Zone: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(zone));
00146         log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(\textcolor{stringliteral}{"Side: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(side));
00147 
00148         this->zone = \hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone};
00149         this->side = \hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side};
00150 
00151         log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(\textcolor{stringliteral}{"Setting HSV threshold values"});
00152 
00153         rangeVals[\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436aee38e4d5dd68c4e440825018d549cb47}{Color::Red}] = \{ cv::Scalar(0, 20, 60),
00154             cv::Scalar(12, 255, 255) \};
00155         rangeVals[\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436ad382816a3cbeed082c9e216e7392eed1}{Color::Green}] = \{ cv::Scalar(49, 41, 17),
00156             cv::Scalar(63, 255, 255) \};
00157         rangeVals[\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue}] = \{ cv::Scalar(70, 0, 0),
00158             cv::Scalar(100, 255, 255) \};
00159 
00160         \textcolor{comment}{/* Remember, we're only pretending this color's image is in HSV space.}
00161 \textcolor{comment}{         * It's really in YUV, as required by Jacob yellow-detection algorithm. */}
00162         rangeVals[\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a51e6cd92b6c45f9affdc158ecca2b8b8}{Color::Yellow}] = \{ cv::Scalar(0, 0, 0),
00163             cv::Scalar(255, 255, 20)\};
00164     \}
00165 
\hypertarget{Grabber_8hpp_source_l00166}{}\hyperlink{classChipChipArray_1_1Grabber_aacf089ceb4aa5b263c2cc702fb3daf74}{00166}     \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_aacf089ceb4aa5b263c2cc702fb3daf74}{Grabber::Close}() \{
00167         log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\textcolor{stringliteral}{"Closing Grabber"});
00168         \hyperlink{classChipChipArray_1_1Grabber_a726bcc2367a719cb84de92a981947622}{cam}.\hyperlink{classChipChipArray_1_1PiCamera_a38f8205921d6deec5a2c360ea7d24cc5}{Close}();
00169     \}
00170 
\hypertarget{Grabber_8hpp_source_l00171}{}\hyperlink{classChipChipArray_1_1Grabber_a44e5aeb908634f68de356ad8df3c4bf1}{00171}     \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_a44e5aeb908634f68de356ad8df3c4bf1}{Grabber::Deposit}(\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436}{Color} color) \{
00172         \textcolor{keywordflow}{if}(color == \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue}) \{
00173             arm.\hyperlink{classChipChipArray_1_1Arm_a20c6fe3fe79c16f492a8c18b91427080}{ClawClose}();
00174             sleep(1);
00175             arm.\hyperlink{classChipChipArray_1_1Arm_a8b077a3791d9fc5ef285c1520fe4c5d8}{BaseTilt}(160);
00176             sleep(1);
00177             arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(130);
00178             sleep(1);
00179             arm.\hyperlink{classChipChipArray_1_1Arm_addaedfe85ff2b14ff00c344fc4b40cd6}{BaseTurn}(47);
00180             sleep(1);
00181             arm.\hyperlink{classChipChipArray_1_1Arm_abb33b5bb11034554d632f8c9b95b2c44}{ClawOpen}();
00182             sleep(1);
00183         \} \textcolor{keywordflow}{else} \{
00184             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"Du Idiot! Die Armbewegungen f√ºr diese "}
00185                     \textcolor{stringliteral}{"Farbe sind noch nicht implementiert. Vielleicht sollst "}
00186                     \textcolor{stringliteral}{"du die englische Phrase lernen 'Would you like fries "}
00187                     \textcolor{stringliteral}{"with that?"});
00188         \}
00189     \}
00190 
\hypertarget{Grabber_8hpp_source_l00191}{}\hyperlink{classChipChipArray_1_1Grabber_abecb4047b4f7d5a7e691b7fb581b5a39}{00191}     \textcolor{keywordtype}{void} \hyperlink{classChipChipArray_1_1Grabber_abecb4047b4f7d5a7e691b7fb581b5a39}{Grabber::Extend}() \{
00192         arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(180);
00193         usleep(500000);
00194         arm.\hyperlink{classChipChipArray_1_1Arm_addaedfe85ff2b14ff00c344fc4b40cd6}{BaseTurn}(132);
00195         arm.\hyperlink{classChipChipArray_1_1Arm_a8b077a3791d9fc5ef285c1520fe4c5d8}{BaseTilt}(125);
00196         arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(150);
00197         arm.\hyperlink{classChipChipArray_1_1Arm_a35ec7756840d9d32dcfbb88d831f087f}{WristTwist}(90);
00198         arm.\hyperlink{classChipChipArray_1_1Arm_abb33b5bb11034554d632f8c9b95b2c44}{ClawOpen}();
00199         sleep(2);
00200     \}
00201 
\hypertarget{Grabber_8hpp_source_l00202}{}\hyperlink{classChipChipArray_1_1Grabber_a56639f8f9ba9468bce4b6d69ceb2eb54}{00202}     \hyperlink{definitions_8hpp_ab84ebabb02540c4a7ec341a213abf1dc}{Result} \hyperlink{classChipChipArray_1_1Grabber_a56639f8f9ba9468bce4b6d69ceb2eb54}{Grabber::Load}() \{
00203         \textcolor{keywordflow}{for}(\hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} i = 0; i < 2; i++) \{
00204             \hyperlink{classChipChipArray_1_1Grabber_abecb4047b4f7d5a7e691b7fb581b5a39}{Extend}();
00205 
00206             \textcolor{keywordflow}{try} \{
00207                 \hyperlink{classChipChipArray_1_1Block}{Block} block = (\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone} == \hyperlink{definitions_8hpp_adbd1e7a33d3e1751c7b2aa2562d0ecb9a7fc56270e7a70fa81a5935b72eacbe29}{Zone::A})
00208                     ? \hyperlink{classChipChipArray_1_1Grabber_af49248c957a1695dcde79c0f5f8df99b}{LocateBlocks}(\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue}) : 
      \hyperlink{classChipChipArray_1_1Grabber_ab9b0d6a64b2c94c0d0f810a5ebeef6ec}{LocateBlueBlock}();
00209 
00210                 \hyperlink{definitions_8hpp_aacdc525d6f7bddb3ae95d5c311bd06a1}{float32} baseKonstant = 0.5;
00211                 \textcolor{keywordflow}{if}(block.\hyperlink{classChipChipArray_1_1Block_a2d02c7b99ca656960fc9724587791999}{dRightLeft} > 0) baseKonstant *= -1;
00212                 \hyperlink{definitions_8hpp_aacdc525d6f7bddb3ae95d5c311bd06a1}{float32} degree = baseKonstant * std::sqrt(block.
      \hyperlink{classChipChipArray_1_1Block_a2d02c7b99ca656960fc9724587791999}{dRightLeft});
00213                 arm.\hyperlink{classChipChipArray_1_1Arm_a980f5bd278cbe06aa21754fb8e0324b3}{dBaseTurn}(degree);
00214                 arm.\hyperlink{classChipChipArray_1_1Arm_a6bde822b1be63926e21222f36aad67b3}{dWristTwist}(-degree);
00215                 sleep(1);
00216                 arm.\hyperlink{classChipChipArray_1_1Arm_a8b077a3791d9fc5ef285c1520fe4c5d8}{BaseTilt}(140);
00217                 sleep(1);
00218 
00219                 \hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} bend = (i == 0 ? 100 : 90);
00220 
00221                 \textcolor{comment}{// lower claw over block}
00222                 \textcolor{keywordflow}{for}(\hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} j = 140; j >= bend; j -= 10) \{
00223                     arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(j);
00224                     sleep(1);
00225                 \}
00226 
00227                 \textcolor{comment}{// deposit in bin}
00228                 sleep(1);
00229                 \hyperlink{classChipChipArray_1_1Grabber_a44e5aeb908634f68de356ad8df3c4bf1}{Deposit}();
00230             \} \textcolor{keywordflow}{catch}(std::exception ex) \{
00231                 log.\hyperlink{classChipChipArray_1_1Log_aba7b7b0555f49f4dcf15f4b9fd3e6b34}{Error}(std::string(\textcolor{stringliteral}{"An exception occured attempting "}
00232                             \textcolor{stringliteral}{"to load the blocks in function Grabber::Load(): "}) 
00233                         + ex.what());
00234             \}
00235 
00236 
00237             \textcolor{keywordflow}{if}(i == 0) \{
00238                 arm.\hyperlink{classChipChipArray_1_1Arm_addaedfe85ff2b14ff00c344fc4b40cd6}{BaseTurn}(132);
00239             \} \textcolor{keywordflow}{else} \{
00240                 arm.\hyperlink{classChipChipArray_1_1Arm_addaedfe85ff2b14ff00c344fc4b40cd6}{BaseTurn}(135);
00241                 sleep(1);
00242                 arm.\hyperlink{classChipChipArray_1_1Arm_a8b077a3791d9fc5ef285c1520fe4c5d8}{BaseTilt}(180);
00243                 sleep(1);
00244                 arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(90);
00245                 sleep(1);
00246                 arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(45);
00247                 sleep(1);
00248                 arm.\hyperlink{classChipChipArray_1_1Arm_ac45149e03abfac230b75156bb42e8417}{Elbow}(0);
00249             \}
00250         \}
00251     \}
00252 
00253 
\hypertarget{Grabber_8hpp_source_l00254}{}\hyperlink{classChipChipArray_1_1Grabber_af49248c957a1695dcde79c0f5f8df99b}{00254}     \hyperlink{classChipChipArray_1_1Block}{Block} \hyperlink{classChipChipArray_1_1Grabber_af49248c957a1695dcde79c0f5f8df99b}{Grabber::LocateBlocks}(\hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436}{Color} color) \{
00255         invokeCount++;
00256         std::string logstr = \textcolor{stringliteral}{"Locating blocks"};
00257 
00258         \textcolor{keywordflow}{if}(color == \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a1e700ac224a6d34c5b171bb6f462aa41}{Color::Perrywinkle}) \{
00259             logstr += \textcolor{stringliteral}{" ("} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(color) + \textcolor{stringliteral}{")"};
00260         \}
00261 
00262         log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(logstr);
00263 
00264         cv::Mat imgOrig;
00265         cv::transpose(\hyperlink{classChipChipArray_1_1Grabber_a726bcc2367a719cb84de92a981947622}{cam}.\hyperlink{classChipChipArray_1_1PiCamera_a58fb0de02570dce9a9cb60a1a04fb84f}{Snap}(), imgOrig);
00266 
00267         cv::Mat imgHSV;
00268         cv::Mat imgThresh;
00269         std::vector<cv::Rect> blocks;
00270         std::vector<Color> colors;
00271 
00272         \hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} loopNum = (color == \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a1e700ac224a6d34c5b171bb6f462aa41}{Color::Perrywinkle} ? rangeVals.size() : 1);
00273 
00274         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < loopNum; i++) \{
00275             \textcolor{keywordflow}{if}(loopNum > 1) \{
00276                 \textcolor{keywordflow}{switch}(i) \{
00277                     \textcolor{keywordflow}{case} 0:
00278                         color = \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436aee38e4d5dd68c4e440825018d549cb47}{Color::Red};
00279                         \textcolor{keywordflow}{break};
00280 
00281                     \textcolor{keywordflow}{case} 1:
00282                         color = \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436ad382816a3cbeed082c9e216e7392eed1}{Color::Green};
00283                         \textcolor{keywordflow}{break};
00284 
00285                     \textcolor{keywordflow}{case} 2:
00286                         color = \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue};
00287                         \textcolor{keywordflow}{break};
00288 
00289                         \textcolor{comment}{/* Must be last, because it changes imgHSV from HSV space}
00290 \textcolor{comment}{                         * to YUV space. */}
00291                     \textcolor{keywordflow}{case} 3: 
00292                         color = \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a51e6cd92b6c45f9affdc158ecca2b8b8}{Color::Yellow};
00293                         \textcolor{keywordflow}{break};
00294                 \}
00295             \}
00296 
00297             log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(\textcolor{stringliteral}{"Searching: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(color));
00298 
00299             \textcolor{keywordflow}{if}(color == \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a51e6cd92b6c45f9affdc158ecca2b8b8}{Color::Yellow}) \{
00300                 cv::Mat temp;
00301                 imgOrig.copyTo(temp);
00302                 cv::cvtColor(imgOrig, imgHSV, CV\_BGR2YUV);
00303                 cv::cvtColor(imgHSV, temp, CV\_HSV2BGR);
00304                 cv::cvtColor(temp, imgHSV, cv::COLOR\_BGR2HSV);
00305                 log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(temp, \textcolor{stringliteral}{"yuv\_yellow\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(color)
00306                         + \textcolor{stringliteral}{"\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00307                         + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00308                         + \textcolor{stringliteral}{".bmp"});
00309             \} \textcolor{keywordflow}{else} \{
00310                 cv::cvtColor(imgOrig, imgHSV, cv::COLOR\_BGR2HSV);
00311             \}
00312 
00313             cv::inRange(imgHSV, rangeVals[color][0],
00314                     rangeVals[color][1], imgThresh);
00315 
00316             \textcolor{comment}{/* }
00317 \textcolor{comment}{             * Not quite sure what all this does, but it seems to}
00318 \textcolor{comment}{             * relate to smoothing the image}
00319 \textcolor{comment}{             */}
00320             cv::erode(imgThresh, imgThresh,
00321                     cv::getStructuringElement(
00322                         cv::MORPH\_ELLIPSE,
00323                         \hyperlink{definitions_8hpp_a9809446fd16a744b6df9808293f14153}{cv::Size}(5, 5)));
00324             cv::dilate(imgThresh, imgThresh,
00325                     cv::getStructuringElement(
00326                         cv::MORPH\_ELLIPSE,
00327                         \hyperlink{definitions_8hpp_a9809446fd16a744b6df9808293f14153}{cv::Size}(5, 5)));
00328             cv::dilate(imgThresh, imgThresh,
00329                     cv::getStructuringElement(
00330                         cv::MORPH\_ELLIPSE,
00331                         \hyperlink{definitions_8hpp_a9809446fd16a744b6df9808293f14153}{cv::Size}(5, 5)));
00332             cv::erode(imgThresh, imgThresh,
00333                     cv::getStructuringElement(
00334                         cv::MORPH\_ELLIPSE,
00335                         \hyperlink{definitions_8hpp_a9809446fd16a744b6df9808293f14153}{cv::Size}(5, 5)));
00336 
00337             log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(imgThresh, \textcolor{stringliteral}{"thresh\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(color)
00338                     + \textcolor{stringliteral}{"\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00339                     + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00340                     + \textcolor{stringliteral}{".bmp"});
00341 
00342             \textcolor{comment}{// calculate contours}
00343             std::vector<std::vector<cv::Point>> contours;
00344             cv::findContours(imgThresh, contours, CV\_RETR\_TREE,
00345                     CV\_CHAIN\_APPROX\_SIMPLE,
00346                     cv::Point(0, 0));
00347             std::vector<std::vector<cv::Point>>
00348                 contours\_poly(contours.size());
00349             std::vector<cv::Rect> bounds(contours.size());
00350 
00351             \textcolor{comment}{// find rectangle around polygon-ish shapes}
00352             \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < contours.size(); i++) \{
00353                 \hyperlink{definitions_8hpp_a1134b580f8da4de94ca6b1de4d37975e}{uint32} area = cv::contourArea(contours[i]);
00354 
00355                 \textcolor{comment}{// determine if block and add to blocks vector}
00356                 \textcolor{keywordflow}{if}(area > MIN\_HALF\_BLOCK\_SIZE) \{
00357                     cv::approxPolyDP(cv::Mat(contours[i]),
00358                             contours\_poly[i], 20,
00359                             \textcolor{keyword}{false});
00360                     cv::Rect rect = cv::boundingRect(
00361                             cv::Mat(contours\_poly[i]));
00362                     log.\hyperlink{classChipChipArray_1_1Log_ac32b435af1577e4ebc67af2bdfea8eff}{Debug}(\hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(color)
00363                             + \textcolor{stringliteral}{" block detected "}
00364                             \textcolor{stringliteral}{"with area "}
00365                             + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(
00366                                 area));
00367                     blocks.push\_back(rect);
00368                     colors.push\_back(color);
00369                 \}
00370             \}
00371         \}
00372 
00373         \textcolor{keywordflow}{if}(blocks.size() == 0) \{
00374             log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(imgOrig, \textcolor{stringliteral}{"original\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(
      \hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00375                     + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00376                     + \textcolor{stringliteral}{"\_no\_blocks.bmp"});
00377             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"No blocks found!"});
00378         \} \textcolor{keywordflow}{else} \{
00379             log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(blocks.size())
00380                     + \textcolor{stringliteral}{" blocks found"});
00381         \}
00382 
00383         \textcolor{comment}{// coordinates start in top right}
00384         \hyperlink{classChipChipArray_1_1Block}{Block} block = \hyperlink{classChipChipArray_1_1Block}{Block}(blocks[0], colors[0]);
00385 
00386         \textcolor{keywordflow}{if}(blocks.size() > 1) \{
00387             \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 1; i < blocks.size(); i++) \{ 
00388                 \textcolor{keywordflow}{if}((\hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side} == \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142a92b09c7c48c520c3c55e497875da437c}{Side::Right} && blocks[i].x 
00389                             > block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft}.x)
00390                         || (\hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side} == \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142a945d5e233cf7d6240f6b783b36a374ff}{Side::Left}
00391                             && blocks[i].x
00392                             < block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft}.x)) \{
00393                     block = \hyperlink{classChipChipArray_1_1Block}{Block}(blocks[i], colors[i]);
00394                 \}
00395             \}
00396         \}
00397 
00398         log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a262210a9a04028f3f2670c9ae38ef3d7}{color}) + \textcolor{stringliteral}{" block is located"});
00399 
00400         log.\hyperlink{classChipChipArray_1_1Log_ac32b435af1577e4ebc67af2bdfea8eff}{Debug}(\textcolor{stringliteral}{"Block properties => area: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.
      \hyperlink{classChipChipArray_1_1Block_ab5f9a9c1cc11e949685f8ad3d52599b2}{area})
00401                 + \textcolor{stringliteral}{", height: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_aed94802c166c9b4553764eb637717a2a}{height}) + \textcolor{stringliteral}{", width: "}
00402                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_ac3f815e8aa9060c4ad20d4e1b2649e35}{width}) + \textcolor{stringliteral}{", offset: "}
00403                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a42e2ca0775dc09b04049a2db1bc0bb4f}{offset}) + \textcolor{stringliteral}{", color: "}
00404                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a262210a9a04028f3f2670c9ae38ef3d7}{color}) + \textcolor{stringliteral}{", size: "}
00405                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_aebd356d7fcfe7ff11db8195e6d7f8e42}{size}));
00406 
00407         \textcolor{comment}{/* }
00408 \textcolor{comment}{         * Draw surrounding rectangles from above on original}
00409 \textcolor{comment}{         * image.}
00410 \textcolor{comment}{         */}
00411         cv::rectangle(imgOrig, block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft} , block.\hyperlink{classChipChipArray_1_1Block_a82f831883d31e6d74be45b8851eefe96}{bottomRight},
00412                 cv::Scalar(255, 0, 0), 4, 8);
00413         log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(imgOrig, \textcolor{stringliteral}{"original\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00414                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00415                 + \textcolor{stringliteral}{".bmp"});
00416 
00417         \textcolor{keywordflow}{return} block;
00418     \}
00419 
\hypertarget{Grabber_8hpp_source_l00420}{}\hyperlink{classChipChipArray_1_1Grabber_ab9b0d6a64b2c94c0d0f810a5ebeef6ec}{00420}     \hyperlink{classChipChipArray_1_1Block}{Block} \hyperlink{classChipChipArray_1_1Grabber_ab9b0d6a64b2c94c0d0f810a5ebeef6ec}{Grabber::LocateBlueBlock}() \{
00421         std::vector<cv::Mat> channels;
00422         std::vector<cv::Rect> blocks;   
00423 
00424         invokeCount++;
00425         log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\textcolor{stringliteral}{"Locating blue blocks"});
00426 
00427         cv::Mat img;
00428         cv::Mat imgThresh;
00429         cv::split(\hyperlink{classChipChipArray_1_1Grabber_a726bcc2367a719cb84de92a981947622}{cam}.\hyperlink{classChipChipArray_1_1PiCamera_a58fb0de02570dce9a9cb60a1a04fb84f}{Snap}(), channels);
00430         cv::transpose(channels[0], img);
00431 
00432         log.\hyperlink{classChipChipArray_1_1Log_a154a5f38d9c7a767693b242684a3d4d9}{Verbose}(\textcolor{stringliteral}{"Searching: Blue block"});
00433         cv::inRange(img, 30, 255, imgThresh);
00434         log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(imgThresh, \textcolor{stringliteral}{"thresh\_blue"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(
      \hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00435                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount) + \textcolor{stringliteral}{".bmp"});
00436 
00437         \textcolor{comment}{// calculate contours}
00438         std::vector<std::vector<cv::Point>> contours;
00439         cv::findContours(imgThresh, contours, CV\_RETR\_TREE,
00440                 CV\_CHAIN\_APPROX\_SIMPLE,
00441                 cv::Point(0, 0));
00442         std::vector<std::vector<cv::Point>>
00443             contours\_poly(contours.size());
00444         std::vector<cv::Rect> bounds(contours.size());
00445 
00446         \textcolor{comment}{// find rectangle around polygon-ish shapes}
00447         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < contours.size(); i++) \{
00448             \hyperlink{definitions_8hpp_a1134b580f8da4de94ca6b1de4d37975e}{uint32} area = cv::contourArea(contours[i]);
00449 
00450             \textcolor{comment}{// determine if block and add to blocks vector}
00451             \textcolor{keywordflow}{if}(area > MIN\_HALF\_BLOCK\_SIZE) \{
00452                 cv::approxPolyDP(cv::Mat(contours[i]),
00453                         contours\_poly[i], 20,
00454                         \textcolor{keyword}{false});
00455                 cv::Rect rect = cv::boundingRect(
00456                         cv::Mat(contours\_poly[i]));
00457                 log.\hyperlink{classChipChipArray_1_1Log_ac32b435af1577e4ebc67af2bdfea8eff}{Debug}(\textcolor{stringliteral}{"Blue block detected with area "}
00458                         + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(area));
00459                 blocks.push\_back(rect);
00460             \}
00461         \}
00462 
00463 
00464         \textcolor{keywordflow}{if}(blocks.size() == 0) \{
00465             log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(img, \textcolor{stringliteral}{"original\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00466                     + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00467                     + \textcolor{stringliteral}{"\_no\_blocks.bmp"});
00468             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"No blocks found!"});
00469         \} \textcolor{keywordflow}{else} \{
00470             log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(blocks.size())
00471                     + \textcolor{stringliteral}{" blocks found"});
00472         \}
00473 
00474         \textcolor{comment}{// coordinates start in top right}
00475         \hyperlink{classChipChipArray_1_1Block}{Block} block = \hyperlink{classChipChipArray_1_1Block}{Block}(blocks[0], \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue});
00476 
00477         \textcolor{keywordflow}{if}(blocks.size() > 1) \{
00478             \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 1; i < blocks.size(); i++) \{ 
00479                 \textcolor{keywordflow}{if}((\hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side} == \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142a92b09c7c48c520c3c55e497875da437c}{Side::Right} && blocks[i].x 
00480                             > block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft}.x)
00481                         || (\hyperlink{classChipChipArray_1_1Grabber_a8afbaefae7c767c862fd1bf13968539b}{side} == \hyperlink{definitions_8hpp_a03325a8a9d4f105db5e37dd587128142a945d5e233cf7d6240f6b783b36a374ff}{Side::Left}
00482                             && blocks[i].x
00483                             < block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft}.x)) \{
00484                     block = \hyperlink{classChipChipArray_1_1Block}{Block}(blocks[i], \hyperlink{definitions_8hpp_abc05a0f46084a3477cf5d5c939ff1436a9594eec95be70e7b1710f730fdda33d9}{Color::Blue});
00485                 \}
00486             \}
00487         \}
00488 
00489         log.\hyperlink{classChipChipArray_1_1Log_a66575b6e94c6112e4cefa5736cb996e0}{Status}(\hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a262210a9a04028f3f2670c9ae38ef3d7}{color}) + \textcolor{stringliteral}{" block is located"});
00490 
00491         log.\hyperlink{classChipChipArray_1_1Log_ac32b435af1577e4ebc67af2bdfea8eff}{Debug}(\textcolor{stringliteral}{"Block properties => area: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.
      \hyperlink{classChipChipArray_1_1Block_ab5f9a9c1cc11e949685f8ad3d52599b2}{area})
00492                 + \textcolor{stringliteral}{", height: "} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_aed94802c166c9b4553764eb637717a2a}{height}) + \textcolor{stringliteral}{", width: "}
00493                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_ac3f815e8aa9060c4ad20d4e1b2649e35}{width}) + \textcolor{stringliteral}{", offset: "}
00494                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a42e2ca0775dc09b04049a2db1bc0bb4f}{offset}) + \textcolor{stringliteral}{", color: "}
00495                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_a262210a9a04028f3f2670c9ae38ef3d7}{color}) + \textcolor{stringliteral}{", size: "}
00496                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(block.\hyperlink{classChipChipArray_1_1Block_aebd356d7fcfe7ff11db8195e6d7f8e42}{size}));
00497 
00498         \textcolor{comment}{/* }
00499 \textcolor{comment}{         * Draw surrounding rectangles from above on original}
00500 \textcolor{comment}{         * image.}
00501 \textcolor{comment}{         */}
00502         cv::rectangle(img, block.\hyperlink{classChipChipArray_1_1Block_aeecc05025c6c8e23ff6ca09a6fbd4b4b}{topLeft} , block.\hyperlink{classChipChipArray_1_1Block_a82f831883d31e6d74be45b8851eefe96}{bottomRight},
00503                 cv::Scalar(255, 0, 0), 4, 8);
00504         log.\hyperlink{classChipChipArray_1_1Log_a65bbab057c8b1453f9e4efcfee7522c4}{Image}(img, \textcolor{stringliteral}{"original\_"} + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(\hyperlink{classChipChipArray_1_1Grabber_ab57efe6e0b6f369b19528285a278d967}{zone})
00505                 + \hyperlink{namespacestd_aa5ddf582a1c96ffe258c997be9a294a3}{std::to\_string}(invokeCount)
00506                 + \textcolor{stringliteral}{".bmp"});
00507 
00508         \textcolor{keywordflow}{return} block;
00509     \}
00510 \}
00511 
00512 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
